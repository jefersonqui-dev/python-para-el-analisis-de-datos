# GitHub Actions Workflow para Curso Python Junior con IA
# Ejecuta tests, linting y verificaciones de calidad automÃ¡ticamente

name: Python Application CI/CD

# Cuando se ejecuta este workflow
on:
  # En cada push a main o desarrollo
  push:
    branches: [main, develop]
  # En cada pull request a main
  pull_request:
    branches: [main]
  # Permite ejecuciÃ³n manual desde GitHub
  workflow_dispatch:

# Variables de entorno globales
env:
  PYTHON_VERSION: "3.11"

# Permisos necesarios para crear releases
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # Job 1: Testing y Calidad de CÃ³digo
  test-and-lint:
    name: ğŸ§ª Tests y Calidad de CÃ³digo
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
      # Checkout del cÃ³digo
      - name: ğŸ“‚ Checkout cÃ³digo
        uses: actions/checkout@v4

      # Configurar Python
      - name: ğŸ Configurar Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # Cache de dependencias para velocidad
      - name: ğŸ“¦ Cache de dependencias pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Instalar dependencias
      - name: ğŸ“¥ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Instalar herramientas adicionales para CI
          pip install pytest-cov pytest-xvfb

      # Ejecutar flake8 para verificar estilo de cÃ³digo
      - name: ğŸ“ Verificar estilo con flake8
        run: |
          # Verificar errores de sintaxis y nombres indefinidos
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Verificar complejidad y estilo (warning only)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics

      # Ejecutar pycodestyle para verificar estilo PEP8
      - name: ğŸ“ Verificar estilo con pycodestyle
        run: |
          pycodestyle .

      # Ejecutar pydocstyle para verificar docstrings
      - name: ğŸ“š Verificar docstrings con pydocstyle
        run: |
          pydocstyle .

      # Ejecutar pylint para anÃ¡lisis estÃ¡tico
      - name: ğŸ” AnÃ¡lisis estÃ¡tico con pylint
        run: |
          # Analizar mÃ³dulos principales (permitir algunos warnings para estudiantes)
          find . -name "*.py" -path "./modulo_*" | head -10 | xargs pylint --exit-zero --score=yes

      # Ejecutar tests con pytest
      - name: ğŸ§ª Ejecutar tests con pytest
        run: |
          # Buscar y ejecutar todos los tests
          python -m pytest -v --cov=. --cov-report=xml --cov-report=html

      # Subir cobertura de cÃ³digo a Codecov (opcional)
      - name: ğŸ“Š Subir cobertura a Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Job 2: Verificar estructura del proyecto
  verify-structure:
    name: ğŸ“ Verificar Estructura del Proyecto
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ğŸ“‹ Verificar archivos esenciales
        run: |
          echo "ğŸ” Verificando estructura del proyecto..."

          # Verificar archivos raÃ­z obligatorios
          test -f README.md || (echo "âŒ README.md faltante" && exit 1)
          test -f requirements.txt || (echo "âŒ requirements.txt faltante" && exit 1)
          test -f setup_instructions.md || (echo "âŒ setup_instructions.md faltante" && exit 1)
          test -f .gitignore || (echo "âŒ .gitignore faltante" && exit 1)

          # Verificar estructura de mÃ³dulos
          test -d modulo_1_fundamentos || (echo "âŒ modulo_1_fundamentos faltante" && exit 1)
          test -d recursos || (echo "âŒ carpeta recursos faltante" && exit 1)

          # Verificar que existen archivos Python
          find . -name "*.py" | head -1 > /dev/null || (echo "âŒ No se encontraron archivos Python" && exit 1)

          echo "âœ… Estructura del proyecto verificada correctamente"

      - name: ğŸ“š Verificar documentaciÃ³n
        run: |
          echo "ğŸ“– Verificando calidad de documentaciÃ³n..."

          # Contar archivos README
          readme_count=$(find . -name "README.md" | wc -l)
          echo "ğŸ“„ Archivos README encontrados: $readme_count"

          # Verificar que hay documentaciÃ³n en mÃ³dulos
          if [ $readme_count -lt 2 ]; then
            echo "âš ï¸ Pocos archivos de documentaciÃ³n encontrados"
          else
            echo "âœ… DocumentaciÃ³n adecuada presente"
          fi

          # Verificar archivos de ejemplo
          ejemplo_count=$(find . -name "ejemplo_*.py" | wc -l)
          echo "ğŸ’» Archivos de ejemplo encontrados: $ejemplo_count"

  # Job 3: Verificar cÃ³digo de estudiantes
  student-code-check:
    name: ğŸ‘¨â€ğŸ“ VerificaciÃ³n de CÃ³digo Estudiantil
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ğŸ“¥ Instalar dependencias bÃ¡sicas
        run: |
          python -m pip install --upgrade pip
          pip install black

      - name: ğŸ” Verificar sintaxis Python
        run: |
          echo "ğŸ Verificando sintaxis de archivos Python..."

          # Verificar que todos los archivos .py son sintÃ¡cticamente correctos
          find . -name "*.py" | while read file; do
            echo "Verificando: $file"
            python -m py_compile "$file" || echo "âŒ Error de sintaxis en: $file"
          done

          echo "âœ… VerificaciÃ³n de sintaxis completada"

      - name: ğŸ“ Verificar estilo bÃ¡sico
        run: |
          echo "ğŸ“ Verificando estilo bÃ¡sico del cÃ³digo..."

          # Verificar archivos de ejemplo especÃ­ficos
          for file in $(find . -name "ejemplo_*.py" | head -5); do
            if [ -f "$file" ]; then
              echo "Verificando estilo de: $file"
              # Verificar formateo con black (sin aplicar cambios)
              black --check --diff "$file" || echo "âš ï¸ $file necesita formateo"
            fi
          done

          echo "âœ… VerificaciÃ³n de estilo completada"

  # Job 4: Tests especÃ­ficos del curso
  course-specific-tests:
    name: ğŸ“ Tests EspecÃ­ficos del Curso
    runs-on: ubuntu-latest
    needs: [test-and-lint]

    steps:
      - name: ğŸ“‚ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ğŸ“¥ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ§ª Ejecutar tests de mÃ³dulos
        run: |
          echo "ğŸ§ª Ejecutando tests especÃ­ficos del curso..."

          # Buscar y ejecutar archivos de test en cada mÃ³dulo
          for modulo in modulo_*; do
            if [ -d "$modulo" ]; then
              echo "ğŸ“ Verificando mÃ³dulo: $modulo"
              
              # Buscar archivos de test o ejemplo ejecutables
              find "$modulo" -name "*.py" | while read file; do
                if [[ "$file" == *"ejemplo_"* ]] || [[ "$file" == *"test_"* ]]; then
                  echo "ğŸ” Verificando ejecutabilidad: $file"
                  timeout 30s python "$file" < /dev/null || echo "âš ï¸ Problema ejecutando: $file"
                fi
              done
            fi
          done

          echo "âœ… Tests de mÃ³dulos completados"

      - name: ğŸ“Š Generar reporte de calidad
        run: |
          echo "ğŸ“Š Generando reporte de calidad del cÃ³digo..."

          # Contar archivos y lÃ­neas de cÃ³digo
          echo "ğŸ“ˆ ESTADÃSTICAS DEL PROYECTO:"
          echo "- Archivos Python: $(find . -name '*.py' | wc -l)"
          echo "- LÃ­neas de cÃ³digo: $(find . -name '*.py' -exec wc -l {} + | tail -1)"
          echo "- Archivos de documentaciÃ³n: $(find . -name '*.md' | wc -l)"
          echo "- MÃ³dulos del curso: $(find . -maxdepth 1 -name 'modulo_*' -type d | wc -l)"

          echo "âœ… Reporte de calidad generado"

  # Job 5: Deployment/Release (solo en main)
  deploy:
    name: ğŸš€ Deploy Template
    runs-on: ubuntu-latest
    needs:
      [
        test-and-lint,
        verify-structure,
        student-code-check,
        course-specific-tests,
      ]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“‚ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Crear release automÃ¡tico
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Template Release v${{ github.run_number }}
          body: |
            ğŸ“ Nueva versiÃ³n del template de curso Python Junior con IA

            âœ… Todos los tests pasaron
            âœ… Calidad de cÃ³digo verificada
            âœ… Estructura del proyecto validada
            âœ… DocumentaciÃ³n actualizada

            ğŸ”— Commit: ${{ github.sha }}
            ğŸ• Fecha: ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false
# ConfiguraciÃ³n adicional para notificaciones (opcional)
# Se puede configurar para enviar notificaciones a Discord, Slack, etc.